@page "/"
@rendermode InteractiveServer
@using GameTribunal.Web.Services
@using GameTribunal.Domain.Enumerations
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

<PageTitle>Pandorium - Lobby</PageTitle>

<div class="game-container lobby-container game-animate-fadeIn">
    @if (_room is null)
    {
        <!-- Pre-Game: Compact hero + form -->
        <div class="game-hero game-hero-lobby-compact">
            <div class="game-hero-content">
                <h1 class="game-title">‚öñÔ∏è Pandorium</h1>
                <p class="game-subtitle">
                    El juego social definitivo para 4-16 jugadores.<br/>
                    Acusa, defiende y decide qui√©n recibe cada t√≠tulo en tu grupo.
                </p>
            </div>
        </div>

        <!-- Compact configuration form -->
        <GameCard class="game-animate-slideIn">
            <Header>
                <h2 class="game-card-title">üéÆ Configurar Partida</h2>
            </Header>
            <Body>
                <GameStack Direction="vertical" Gap="2">
                    <div class="game-form-group">
                        <label class="game-label" for="gameMode">
                            <span style="font-size: 1.25rem;">üéØ</span> Modo de Juego
                        </label>
                        <select id="gameMode" class="game-select" @bind="_selectedMode" autofocus @ref="_gameModeSelect">
                            @foreach (var mode in _availableModes)
                            {
                                <option value="@mode">
                                    @(mode == GameMode.Suave ? "üòä Suave" :
                                      mode == GameMode.Normal ? "üòé Normal" :
                                      "üî• Spicy")
                                </option>
                            }
                        </select>
                        <small class="text-muted mt-1" style="display: block; font-size: 0.75rem;">
                            @GetModeDescription(_selectedMode)
                        </small>
                    </div>

                    <GameButton 
                        Variant="primary" 
                        Size="lg" 
                        FullWidth="true" 
                        IsLoading="@_isCreating"
                        OnClick="CreateRoomAsync">
                        <span style="font-size: 1.25rem;">üöÄ</span>
                        <span>Crear Sala</span>
                    </GameButton>

                    @if (_errorMessage is not null)
                    {
                        <GameAlert Variant="danger">
                            <Title>Error</Title>
                            <Message>@_errorMessage</Message>
                        </GameAlert>
                    }
                </GameStack>
            </Body>
        </GameCard>

        <!-- Info Cards -->
        <div class="game-grid game-grid-2 mt-4">
            <GameCard>
                <Body>
                    <GameStack Direction="vertical" Gap="2" AlignItems="center">
                        <div style="font-size: 3rem;">üì±</div>
                        <h3 class="text-center mb-0" style="font-size: 1.5rem;">Sin Instalaci√≥n</h3>
                        <p class="text-center text-muted mb-0">
                            Solo necesitas un navegador web. Escanea el QR con tu m√≥vil y listo.
                        </p>
                    </GameStack>
                </Body>
            </GameCard>
            <GameCard>
                <Body>
                    <GameStack Direction="vertical" Gap="2" AlignItems="center">
                        <div style="font-size: 3rem;">üë•</div>
                        <h3 class="text-center mb-0" style="font-size: 1.5rem;">4-16 Jugadores</h3>
                        <p class="text-center text-muted mb-0">
                            Perfecto para grupos peque√±os y grandes. Todos en la misma sala f√≠sica.
                        </p>
                    </GameStack>
                </Body>
            </GameCard>
        </div>
    }
    else
    {
        <!-- After room creation: NO HERO, only essential elements visible without scroll -->
        
        <!-- Compact header with mode badge and "Create New Room" button at top right -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-md);">
            <div style="text-align: center; flex: 1;">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-light); margin-bottom: var(--space-sm);">
                    ‚öñÔ∏è Pandorium
                </h2>
                <span style="background: @GetModeGradient(_room.Mode); display: inline-flex; align-items: center; padding: var(--space-xs) var(--space-md); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); border-radius: var(--radius-full); color: var(--color-light); box-shadow: var(--shadow-md);">
                    @GetModeEmoji(_room.Mode) @_room.Mode
                </span>
            </div>
            <div>
                <GameButton 
                    Variant="outline"
                    Size="sm"
                    Disabled="@_isCreating"
                    OnClick="CreateAnotherRoomAsync">
                    <span style="font-size: 1rem;">üîÑ</span>
                    <span style="font-size: 0.875rem;">Crear Nueva Sala</span>
                </GameButton>
            </div>
        </div>

        <!-- RNF-011 Section 3.1: Compact timeline for lobby preparation progress -->
        <div class="game-timeline game-timeline-compact">
            <div class="game-timeline-step completed">
                <div class="game-timeline-icon">‚úì</div>
                <div class="game-timeline-label">Sala Creada</div>
            </div>
            <div class="game-timeline-step @(_room.Players.Count > 0 ? "completed" : "active")">
                <div class="game-timeline-icon">@(_room.Players.Count > 0 ? "‚úì" : "üë•")</div>
                <div class="game-timeline-label">Jugadores</div>
            </div>
            <div class="game-timeline-step @(_room.CanStartGame ? "active" : "")">
                <div class="game-timeline-icon">üéÆ</div>
                <div class="game-timeline-label">Iniciar</div>
            </div>
        </div>

        <!-- RNF-011 Section 3.1: Compact split layout - QR card (left) and roster card (right) -->
        <div class="game-grid game-grid-2">
            <!-- Left: Compact QR card -->
            <GameCard class="game-card-spotlight game-card-compact game-animate-fadeIn">
                <Body>
                    <div class="game-qr-container game-qr-container-compact">
                        <div class="game-room-code game-room-code-compact">
                            @_room.Code
                        </div>

                        @if (_qrCodeBase64 is not null)
                        {
                            <div class="game-qr-image">
                                <img src="data:image/png;base64,@_qrCodeBase64" 
                                     alt="C√≥digo QR para unirse" 
                                     style="max-width: 150px; width: 100%;" />
                            </div>
                            
                            <!-- RF-007: Compact share button -->
                            <GameButton 
                                Variant="outline"
                                Size="sm"
                                FullWidth="true"
                                OnClick="ShareRoomUrlAsync">
                                <span style="font-size: 1rem;">üì§</span>
                                <span style="font-size: 0.875rem;">@_shareButtonText</span>
                            </GameButton>
                        }
                    </div>
                </Body>
            </GameCard>

            <!-- Right: Compact roster card -->
            <GameCard class="game-card-roster game-card-compact game-animate-slideIn">
                <Header>
                    <h3 class="game-card-title" style="font-size: var(--font-size-lg);">
                        üë• Jugadores
                        <GameBadge Variant="primary" Size="md" class="ms-2">
                            @_room.Players.Count/@Room.MaxPlayers
                        </GameBadge>
                    </h3>
                </Header>
                <Body>
                    @if (_room.Players.Count == 0)
                    {
                        <p class="text-muted text-center" style="font-size: 0.875rem; padding: var(--space-md) 0;">
                            Esperando jugadores...
                        </p>
                    }
                    else
                    {
                        <ul class="game-player-list game-player-list-compact">
                            @{
                                var playerIndex = 0;
                            }
                            @foreach (var player in _room.Players.Take(6))
                            {
                                playerIndex++;
                                <li class="game-player-item game-player-item-compact">
                                    <div class="d-flex align-items-center gap-1">
                                        <span style="font-size: 1.125rem;">üë§</span>
                                        <span class="game-player-name" style="font-size: var(--font-size-sm);">@player.Alias</span>
                                    </div>
                                    <span class="game-chip-status game-chip-status-@GetStatusClass(player.ConnectionStatus)" style="font-size: 0.625rem; padding: 2px 6px;">
                                        @GetStatusText(player.ConnectionStatus)
                                    </span>
                                </li>
                            }
                            @if (_room.Players.Count > 6)
                            {
                                <li class="text-muted text-center" style="font-size: 0.75rem; padding: var(--space-xs);">
                                    +@(_room.Players.Count - 6) m√°s
                                </li>
                            }
                        </ul>
                    }

                    @if (!_room.CanStartGame)
                    {
                        <div class="mt-2">
                            <small class="text-warning d-block text-center" style="font-size: 0.75rem;">
                                ‚è≥ M√≠nimo @Room.MinPlayers jugadores (@_room.Players.Count/@Room.MinPlayers)
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="mt-2">
                            <!-- RNF-011 Section 3.1: Compact CTA -->
                            <GameButton 
                                Variant="secondary" 
                                Size="md" 
                                FullWidth="true"
                                IsLoading="@_isStarting"
                                OnClick="StartGameAsync">
                                <span style="font-size: 1.125rem;">üéØ</span>
                                <span style="font-size: 0.875rem;">Iniciar Partida</span>
                            </GameButton>
                        </div>
                    }
                </Body>
            </GameCard>
        </div>
    }
</div>

@code {
    private GameMode _selectedMode = GameMode.Normal;
    private RoomDto? _room;
    private ElementReference _gameModeSelect;
    private string? _errorMessage;
    private bool _isCreating;
    private bool _isStarting;
    private string? _qrCodeBase64;
    private string? _roomUrl;
    private readonly GameMode[] _availableModes = Enum.GetValues<GameMode>();
    private HubConnection? _hubConnection;
    
    // RF-007: Web Share API support
    private string _shareButtonText = "Compartir Enlace";
    private string? _shareMessage;

    [Inject]
    private SignalRRoomService RoomService { get; set; } = default!;

    [Inject]
    private QrCodeService QrCodeService { get; set; } = default!;

    [Inject]
    private IConfiguration Configuration { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private string GetModeDescription(GameMode mode) => mode switch
    {
        GameMode.Suave => "Casos suaves, ideal para grupos que se est√°n conociendo",
        GameMode.Normal => "Casos equilibrados para cualquier grupo de amigos",
        GameMode.Spicy => "Casos atrevidos solo para grupos de m√°xima confianza",
        _ => ""
    };

    /// <summary>
    /// Gets the CSS class for status chip based on connection status (RNF-011 Section 3.1).
    /// </summary>
    private static string GetStatusClass(PlayerConnectionStatus status) => status switch
    {
        PlayerConnectionStatus.Conectado => "connected",
        PlayerConnectionStatus.Inactivo => "inactive",
        PlayerConnectionStatus.Desconectado => "disconnected",
        _ => "disconnected"
    };

    /// <summary>
    /// Gets the status text for a player (RF-013).
    /// </summary>
    private static string GetStatusText(PlayerConnectionStatus status) => status switch
    {
        PlayerConnectionStatus.Conectado => "Conectado",
        PlayerConnectionStatus.Inactivo => "Inactivo",
        PlayerConnectionStatus.Desconectado => "Desconectado",
        _ => ""
    };

    private string GetModeEmoji(GameMode mode) => mode switch
    {
        GameMode.Suave => "üòä",
        GameMode.Normal => "üòé",
        GameMode.Spicy => "üî•",
        _ => "üéÆ"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if there's an existing host session (RF-017)
            await RestoreHostSessionAsync();
            
            // Only try to focus if there's no room (avoid error when room is restored)
            if (_room is null)
            {
                try
                {
                    await _gameModeSelect.FocusAsync();
                }
                catch (Exception)
                {
                    // Ignore focus errors if the element is not yet available.
                }
            }
        }
    }

    private string GetModeGradient(GameMode mode) => mode switch
    {
        GameMode.Suave => "linear-gradient(135deg, #06D6A0 0%, #4CC9F0 100%)",
        GameMode.Normal => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)",
        GameMode.Spicy => "linear-gradient(135deg, #F72585 0%, #7209B7 100%)",
        _ => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)"
    };

    private async Task CreateRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        _errorMessage = null;
        _isCreating = true;

        try
        {
            _room = await RoomService.CreateRoomAsync(_selectedMode);
            
            // Generate QR code URL (RF-004)
            var baseUrl = Configuration["BaseUrl"] ?? "https://localhost:7000";
            _roomUrl = RoomService.GenerateRoomUrl(_room.Code, baseUrl);
            _qrCodeBase64 = QrCodeService.GenerateQrCodeBase64(_roomUrl);

            // Save host session (RF-017)
            await SaveHostSessionAsync();

            // Initialize SignalR connection for real-time updates (RF-011)
            await InitializeSignalRConnectionAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task CreateAnotherRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        // Dispose of existing SignalR connection
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
            _hubConnection = null;
        }

        _room = null;
        _errorMessage = null;
        _qrCodeBase64 = null;
        _roomUrl = null;

        await CreateRoomAsync();
    }

    private async Task StartGameAsync()
    {
        if (_isStarting || _room is null || !_room.CanStartGame)
        {
            return;
        }

        _isStarting = true;
        _errorMessage = null;

        try
        {
            // TODO: Implement game start logic
            await Task.Delay(1000); // Simulate async operation
            _errorMessage = "Funcionalidad de inicio de partida pendiente de implementaci√≥n.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al iniciar la partida: {ex.Message}";
        }
        finally
        {
            _isStarting = false;
        }
    }

    /// <summary>
    /// Initializes SignalR connection for real-time room updates (RF-011).
    /// The host doesn't need to join as a player but monitors room state.
    /// </summary>
    private async Task InitializeSignalRConnectionAsync()
    {
        if (_room is null)
        {
            return;
        }

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        // Handle room state updates (RF-011)
        _hubConnection.On<RoomDto>("RoomStateUpdated", async (roomDto) =>
        {
            if (roomDto.Code == _room?.Code)
            {
                _room = roomDto;
                await InvokeAsync(StateHasChanged);
            }
        });

        try
        {
            await _hubConnection.StartAsync();
            
            // Join the room group to receive updates
            await _hubConnection.InvokeAsync("JoinRoom", _room.Code, Guid.Empty);
        }
        catch (Exception ex)
        {
            _errorMessage = $"No se pudo conectar al hub: {ex.Message}";
        }
    }

    /// <summary>
    /// Saves the current host session to browser sessionStorage (RF-017).
    /// </summary>
    private async Task SaveHostSessionAsync()
    {
        if (_room is not null)
        {
            try
            {
                var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/sessionStorage.js");
                await module.InvokeVoidAsync("setItem", "host_room_code", _room.Code);
                await module.InvokeVoidAsync("setItem", "host_is_host", "true");
            }
            catch (Exception)
            {
                // Silently fail if sessionStorage is not available
            }
        }
    }

    /// <summary>
    /// Restores the host session from browser sessionStorage (RF-017).
    /// </summary>
    private async Task RestoreHostSessionAsync()
    {
        try
        {
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/sessionStorage.js");
            var roomCode = await module.InvokeAsync<string?>("getItem", "host_room_code");
            var isHost = await module.InvokeAsync<string?>("getItem", "host_is_host");
            
            if (!string.IsNullOrEmpty(roomCode) && isHost == "true" && _room is null)
            {
                // Try to restore the room
                if (GameTribunal.Domain.ValueObjects.RoomCode.TryFrom(roomCode, out var code))
                {
                    var room = await RoomService.GetRoomByCodeAsync(code);
                    if (room is not null)
                    {
                        _room = room;
                        
                        // Generate QR code URL
                        var baseUrl = Configuration["BaseUrl"] ?? "https://localhost:7000";
                        _roomUrl = RoomService.GenerateRoomUrl(_room.Code, baseUrl);
                        _qrCodeBase64 = QrCodeService.GenerateQrCodeBase64(_roomUrl);
                        
                        // Initialize SignalR connection
                        await InitializeSignalRConnectionAsync();
                        
                        // Force UI update
                        await InvokeAsync(StateHasChanged);
                    }
                    else
                    {
                        // Room no longer exists, clear storage
                        await module.InvokeVoidAsync("removeItem", "host_room_code");
                        await module.InvokeVoidAsync("removeItem", "host_is_host");
                    }
                }
            }
        }
        catch (Exception)
        {
            // Silently fail if sessionStorage is not available or room restoration fails
        }
    }

    /// <summary>
    /// Shares the room URL using the Web Share API or falls back to copying to clipboard (RF-007).
    /// </summary>
    private async Task ShareRoomUrlAsync()
    {
        if (string.IsNullOrEmpty(_roomUrl))
        {
            return;
        }

        _shareMessage = null;

        try
        {
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/shareUrl.js");
            
            // Check if Web Share API is supported
            var isSupported = await module.InvokeAsync<bool>("isShareSupported");
            
            if (isSupported)
            {
                // Use Web Share API
                var shareTitle = "√önete a Pandorium";
                var shareText = $"√önete a la sala {_room?.Code} en Pandorium";
                
                var shared = await module.InvokeAsync<bool>("shareUrl", _roomUrl, shareTitle, shareText);
                
                if (shared)
                {
                    _shareMessage = "¬°Enlace compartido!";
                }
            }
            else
            {
                // Fallback to copying to clipboard
                var copied = await module.InvokeAsync<bool>("copyToClipboard", _roomUrl);
                
                if (copied)
                {
                    _shareButtonText = "Copiar Enlace";
                    _shareMessage = "¬°Enlace copiado al portapapeles!";
                }
                else
                {
                    _shareMessage = "No se pudo copiar el enlace";
                }
            }
            
            await InvokeAsync(StateHasChanged);
            
            // Clear the message after 3 seconds
            await Task.Delay(3000);
            _shareMessage = null;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _shareMessage = $"Error al compartir: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
