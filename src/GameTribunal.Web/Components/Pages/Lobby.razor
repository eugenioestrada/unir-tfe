@page "/"
@rendermode InteractiveServer
@using GameTribunal.Web.Services
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

<PageTitle>Tribunal Social - Lobby</PageTitle>

<div class="game-container game-animate-fadeIn">
    <!-- Hero Section -->
    <div class="game-hero">
        <div class="game-hero-content">
            <h1 class="game-title">‚öñÔ∏è TRIBUNAL SOCIAL</h1>
            <p class="game-subtitle">
                El juego social definitivo para 4-16 jugadores.<br/>
                Acusa, defiende y decide qui√©n recibe cada t√≠tulo en tu grupo.
            </p>
        </div>
    </div>

    @if (_room is null)
    {
        <!-- Pre-Game Setup Card -->
        <div class="game-card game-animate-slideIn">
            <div class="game-card-header">
                <h2 class="game-card-title">üéÆ Configurar Partida</h2>
            </div>
            <div class="game-card-body">
                <div class="game-form-group">
                    <label class="game-label" for="gameMode">
                        <span style="font-size: 1.5rem;">üéØ</span> Modo de Juego
                    </label>
                    <select id="gameMode" class="game-select" @bind="_selectedMode">
                        @foreach (var mode in _availableModes)
                        {
                            <option value="@mode">
                                @(mode == GameMode.Suave ? "üòä Suave - Para conocerse" :
                                  mode == GameMode.Normal ? "üòé Normal - Equilibrado" :
                                  "üî• Spicy - Solo para valientes")
                            </option>
                        }
                    </select>
                    <small class="text-muted mt-1" style="display: block; font-size: 0.875rem;">
                        @GetModeDescription(_selectedMode)
                    </small>
                </div>

                <div class="d-flex gap-2 flex-column flex-md-row">
                    <button class="game-btn game-btn-primary game-btn-lg game-btn-block" 
                            @onclick="CreateRoomAsync" 
                            disabled="@_isCreating">
                        @if (_isCreating)
                        {
                            <span class="game-spinner"></span>
                            <span>Creando sala...</span>
                        }
                        else
                        {
                            <span style="font-size: 1.5rem;">üöÄ</span>
                            <span>Crear Sala</span>
                        }
                    </button>
                </div>

                @if (_errorMessage is not null)
                {
                    <div class="game-alert game-alert-danger mt-3">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Error</strong>
                            <p class="mb-0">@_errorMessage</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Info Cards -->
        <div class="game-grid game-grid-2 mt-4">
            <div class="game-card">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">üì±</div>
                <h3 class="text-center mb-2" style="font-size: 1.5rem;">Sin Instalaci√≥n</h3>
                <p class="text-center text-muted">
                    Solo necesitas un navegador web. Escanea el QR con tu m√≥vil y listo.
                </p>
            </div>
            <div class="game-card">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">üë•</div>
                <h3 class="text-center mb-2" style="font-size: 1.5rem;">4-16 Jugadores</h3>
                <p class="text-center text-muted">
                    Perfecto para grupos peque√±os y grandes. Todos en la misma sala f√≠sica.
                </p>
            </div>
        </div>
    }
    else
    {
        <!-- Room Created - Display QR and Room Info -->
        <div class="game-grid game-grid-2">
            <!-- QR Code and Room Code Card -->
            <div class="game-card game-animate-fadeIn">
                <div class="game-qr-container">
                    <h2 class="game-qr-title">üì≤ Escanea para Unirte</h2>
                    
                    <div class="game-room-code">
                        @_room.Code
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
                        <span class="game-badge game-badge-lg" 
                              style="background: @GetModeGradient(_room.Mode)">
                            @GetModeEmoji(_room.Mode) @_room.Mode
                        </span>
                    </div>

                    @if (_qrCodeBase64 is not null)
                    {
                        <div class="game-qr-image">
                            <img src="data:image/png;base64,@_qrCodeBase64" 
                                 alt="C√≥digo QR para unirse" 
                                 style="max-width: 350px; width: 100%;" />
                        </div>
                        <p class="text-muted" style="font-size: 0.875rem; word-break: break-all;">
                            @_roomUrl
                        </p>
                    }
                </div>
            </div>

            <!-- Players List and Game Start Card -->
            <div class="game-card game-animate-slideIn">
                <div class="game-card-header">
                    <h2 class="game-card-title">
                        üë• Jugadores
                        <span class="game-badge game-badge-primary game-badge-lg ms-2">
                            @_room.Players.Count / @Room.MaxPlayers
                        </span>
                    </h2>
                    @if (_hubConnection?.State == HubConnectionState.Connected)
                    {
                        <span class="game-badge game-badge-success">
                            ‚óè En vivo
                        </span>
                    }
                </div>
                <div class="game-card-body">
                    @if (_room.Players.Count == 0)
                    {
                        <div class="game-loading-container">
                            <div class="game-spinner game-spinner-lg game-animate-pulse"></div>
                            <p class="game-loading-text">Esperando jugadores...</p>
                            <p class="text-muted text-center">
                                Los jugadores pueden unirse escaneando el c√≥digo QR
                            </p>
                        </div>
                    }
                    else
                    {
                        <ul class="game-player-list">
                            @{
                                var playerIndex = 0;
                            }
                            @foreach (var player in _room.Players)
                            {
                                playerIndex++;
                                <li class="game-player-item">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 1.5rem;">üë§</span>
                                        <span class="game-player-name">@player.Alias</span>
                                    </div>
                                    <span class="game-badge game-badge-secondary">
                                        #@playerIndex
                                    </span>
                                </li>
                            }
                        </ul>
                    }

                    @if (!_room.CanStartGame)
                    {
                        <div class="game-alert game-alert-warning mt-3">
                            <span style="font-size: 1.5rem;">‚è≥</span>
                            <div>
                                <strong>Se necesitan m√°s jugadores</strong>
                                <p class="mb-0">
                                    M√≠nimo @Room.MinPlayers jugadores para iniciar 
                                    (@_room.Players.Count/@Room.MinPlayers)
                                </p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="game-alert game-alert-success mt-3">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <div>
                                <strong>¬°Listo para empezar!</strong>
                                <p class="mb-0">Ya ten√©is @_room.Players.Count jugadores conectados</p>
                            </div>
                        </div>
                        
                        <button class="game-btn game-btn-secondary game-btn-lg game-btn-block mt-3" 
                                @onclick="StartGameAsync" 
                                disabled="@_isStarting">
                            @if (_isStarting)
                            {
                                <span class="game-spinner"></span>
                                <span>Iniciando...</span>
                            }
                            else
                            {
                                <span style="font-size: 1.5rem;">üéØ</span>
                                <span>Iniciar Partida</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 d-flex justify-content-center">
            <button class="game-btn game-btn-outline" 
                    @onclick="CreateAnotherRoomAsync" 
                    disabled="@_isCreating">
                <span style="font-size: 1.5rem;">üîÑ</span>
                <span>Crear Nueva Sala</span>
            </button>
        </div>
    }
</div>

@code {
    private GameMode _selectedMode = GameMode.Normal;
    private RoomDto? _room;
    private string? _errorMessage;
    private bool _isCreating;
    private bool _isStarting;
    private string? _qrCodeBase64;
    private string? _roomUrl;
    private readonly GameMode[] _availableModes = Enum.GetValues<GameMode>();
    private HubConnection? _hubConnection;

    [Inject]
    private SignalRRoomService RoomService { get; set; } = default!;

    [Inject]
    private QrCodeService QrCodeService { get; set; } = default!;

    [Inject]
    private IConfiguration Configuration { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private string GetModeDescription(GameMode mode) => mode switch
    {
        GameMode.Suave => "Casos suaves, ideal para grupos que se est√°n conociendo",
        GameMode.Normal => "Casos equilibrados para cualquier grupo de amigos",
        GameMode.Spicy => "Casos atrevidos solo para grupos de m√°xima confianza",
        _ => ""
    };

    private string GetModeEmoji(GameMode mode) => mode switch
    {
        GameMode.Suave => "üòä",
        GameMode.Normal => "üòé",
        GameMode.Spicy => "üî•",
        _ => "üéÆ"
    };

    private string GetModeGradient(GameMode mode) => mode switch
    {
        GameMode.Suave => "linear-gradient(135deg, #06D6A0 0%, #4CC9F0 100%)",
        GameMode.Normal => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)",
        GameMode.Spicy => "linear-gradient(135deg, #F72585 0%, #7209B7 100%)",
        _ => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)"
    };

    private async Task CreateRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        _errorMessage = null;
        _isCreating = true;

        try
        {
            _room = await RoomService.CreateRoomAsync(_selectedMode);
            
            // Generate QR code URL (RF-004)
            var baseUrl = Configuration["BaseUrl"] ?? "https://localhost:7000";
            _roomUrl = RoomService.GenerateRoomUrl(_room.Code, baseUrl);
            _qrCodeBase64 = QrCodeService.GenerateQrCodeBase64(_roomUrl);

            // Initialize SignalR connection for real-time updates (RF-011)
            await InitializeSignalRConnectionAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task CreateAnotherRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        // Dispose of existing SignalR connection
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
            _hubConnection = null;
        }

        _room = null;
        _errorMessage = null;
        _qrCodeBase64 = null;
        _roomUrl = null;

        await CreateRoomAsync();
    }

    private async Task StartGameAsync()
    {
        if (_isStarting || _room is null || !_room.CanStartGame)
        {
            return;
        }

        _isStarting = true;
        _errorMessage = null;

        try
        {
            // TODO: Implement game start logic
            await Task.Delay(1000); // Simulate async operation
            _errorMessage = "Funcionalidad de inicio de partida pendiente de implementaci√≥n.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al iniciar la partida: {ex.Message}";
        }
        finally
        {
            _isStarting = false;
        }
    }

    /// <summary>
    /// Initializes SignalR connection for real-time room updates (RF-011).
    /// The host doesn't need to join as a player but monitors room state.
    /// </summary>
    private async Task InitializeSignalRConnectionAsync()
    {
        if (_room is null)
        {
            return;
        }

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        // Handle room state updates (RF-011)
        _hubConnection.On<RoomDto>("RoomStateUpdated", async (roomDto) =>
        {
            if (roomDto.Code == _room?.Code)
            {
                _room = roomDto;
                await InvokeAsync(StateHasChanged);
            }
        });

        try
        {
            await _hubConnection.StartAsync();
            
            // Join the room group to receive updates
            await _hubConnection.InvokeAsync("JoinRoom", _room.Code, Guid.Empty);
        }
        catch (Exception ex)
        {
            _errorMessage = $"No se pudo conectar al hub: {ex.Message}";
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
