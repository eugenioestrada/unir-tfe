@page "/"
@rendermode InteractiveServer
@using GameTribunal.Web.Services
@using GameTribunal.Domain.Enumerations
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

<PageTitle>Pandorium - Lobby</PageTitle>

<div class="game-container game-animate-fadeIn">
    <!-- Hero Section -->
    <div class="game-hero">
        <div class="game-hero-content">
            <h1 class="game-title">‚öñÔ∏è Pandorium</h1>
            <p class="game-subtitle">
                El juego social definitivo para 4-16 jugadores.<br/>
                Acusa, defiende y decide qui√©n recibe cada t√≠tulo en tu grupo.
            </p>
        </div>
    </div>

    @if (_room is null)
    {
        <!-- Pre-Game Setup Card -->
        <GameCard class="game-animate-slideIn">
            <Header>
                <h2 class="game-card-title">üéÆ Configurar Partida</h2>
            </Header>
            <Body>
                <GameStack Direction="vertical" Gap="3">
                    <div class="game-form-group">
                        <label class="game-label" for="gameMode">
                            <span style="font-size: 1.5rem;">üéØ</span> Modo de Juego
                        </label>
                        <select id="gameMode" class="game-select" @bind="_selectedMode" autofocus @ref="_gameModeSelect">
                            @foreach (var mode in _availableModes)
                            {
                                <option value="@mode">
                                    @(mode == GameMode.Suave ? "üòä Suave - Para conocerse" :
                                      mode == GameMode.Normal ? "üòé Normal - Equilibrado" :
                                      "üî• Spicy - Solo para valientes")
                                </option>
                            }
                        </select>
                        <small class="text-muted mt-1" style="display: block; font-size: 0.875rem;">
                            @GetModeDescription(_selectedMode)
                        </small>
                    </div>

                    <GameButton 
                        Variant="primary" 
                        Size="lg" 
                        FullWidth="true" 
                        IsLoading="@_isCreating"
                        OnClick="CreateRoomAsync">
                        <span style="font-size: 1.5rem;">üöÄ</span>
                        <span>Crear Sala</span>
                    </GameButton>

                    @if (_errorMessage is not null)
                    {
                        <GameAlert Variant="danger">
                            <Title>Error</Title>
                            <Message>@_errorMessage</Message>
                        </GameAlert>
                    }
                </GameStack>
            </Body>
        </GameCard>

        <!-- Info Cards -->
        <div class="game-grid game-grid-2 mt-4">
            <GameCard>
                <Body>
                    <GameStack Direction="vertical" Gap="2" AlignItems="center">
                        <div style="font-size: 3rem;">üì±</div>
                        <h3 class="text-center mb-0" style="font-size: 1.5rem;">Sin Instalaci√≥n</h3>
                        <p class="text-center text-muted mb-0">
                            Solo necesitas un navegador web. Escanea el QR con tu m√≥vil y listo.
                        </p>
                    </GameStack>
                </Body>
            </GameCard>
            <GameCard>
                <Body>
                    <GameStack Direction="vertical" Gap="2" AlignItems="center">
                        <div style="font-size: 3rem;">üë•</div>
                        <h3 class="text-center mb-0" style="font-size: 1.5rem;">4-16 Jugadores</h3>
                        <p class="text-center text-muted mb-0">
                            Perfecto para grupos peque√±os y grandes. Todos en la misma sala f√≠sica.
                        </p>
                    </GameStack>
                </Body>
            </GameCard>
        </div>
    }
    else
    {
        <!-- Room Created - Display QR and Room Info -->
        <div class="game-grid game-grid-2">
            <!-- QR Code and Room Code Card -->
            <GameCard class="game-animate-fadeIn">
                <Body>
                    <div class="game-qr-container">
                        <h2 class="game-qr-title">üì≤ Escanea para Unirte</h2>
                        
                        <div class="game-room-code">
                            @_room.Code
                        </div>
                        
                        <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
                            <span style="background: @GetModeGradient(_room.Mode); display: inline-flex; align-items: center; padding: var(--space-xs) var(--space-lg); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); border-radius: var(--radius-full); white-space: nowrap; color: var(--color-light);">
                                @GetModeEmoji(_room.Mode) @_room.Mode
                            </span>
                        </div>

                        @if (_qrCodeBase64 is not null)
                        {
                            <div class="game-qr-image">
                                <img src="data:image/png;base64,@_qrCodeBase64" 
                                     alt="C√≥digo QR para unirse" 
                                     style="max-width: 350px; width: 100%;" />
                            </div>
                            <p class="text-muted" style="font-size: 0.875rem; word-break: break-all;">
                                @_roomUrl
                            </p>
                        }
                    </div>
                </Body>
            </GameCard>

            <!-- Players List and Game Start Card -->
            <GameCard class="game-animate-slideIn">
                <Header>
                    <h2 class="game-card-title">
                        üë• Jugadores
                        <GameBadge Variant="primary" Size="lg" class="ms-2">
                            @_room.Players.Count / @Room.MaxPlayers
                        </GameBadge>
                    </h2>
                    @if (_hubConnection?.State == HubConnectionState.Connected)
                    {
                        <GameBadge Variant="success">
                            ‚óè En vivo
                        </GameBadge>
                    }
                </Header>
                <Body>
                    @if (_room.Players.Count == 0)
                    {
                        <GameLoadingSpinner Size="lg" Text="Esperando jugadores..." Centered="true">
                        </GameLoadingSpinner>
                        <p class="text-muted text-center mt-2">
                            Los jugadores pueden unirse escaneando el c√≥digo QR
                        </p>
                    }
                    else
                    {
                        <ul class="game-player-list">
                            @{
                                var playerIndex = 0;
                            }
                            @foreach (var player in _room.Players)
                            {
                                playerIndex++;
                                <li class="game-player-item">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 1.25rem;">@GetStatusIndicator(player.ConnectionStatus)</span>
                                        <span style="font-size: 1.5rem;">üë§</span>
                                        <span class="game-player-name">@player.Alias</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">@GetStatusText(player.ConnectionStatus)</small>
                                        <GameBadge Variant="secondary">
                                            #@playerIndex
                                        </GameBadge>
                                    </div>
                                </li>
                            }
                        </ul>
                    }

                    @if (!_room.CanStartGame)
                    {
                        <div class="mt-3">
                            <GameAlert Variant="warning" Icon="‚è≥">
                                <Title>Se necesitan m√°s jugadores</Title>
                                <Message>
                                    M√≠nimo @Room.MinPlayers jugadores para iniciar 
                                    (@_room.Players.Count/@Room.MinPlayers)
                                </Message>
                            </GameAlert>
                        </div>
                    }
                    else
                    {
                        <GameStack Direction="vertical" Gap="2" class="mt-3">
                            <GameAlert Variant="success">
                                <Title>¬°Listo para empezar!</Title>
                                <Message>Ya ten√©is @_room.Players.Count jugadores conectados</Message>
                            </GameAlert>
                            
                            <GameButton 
                                Variant="secondary" 
                                Size="lg" 
                                FullWidth="true"
                                IsLoading="@_isStarting"
                                OnClick="StartGameAsync">
                                <span style="font-size: 1.5rem;">üéØ</span>
                                <span>Iniciar Partida</span>
                            </GameButton>
                        </GameStack>
                    }
                </Body>
            </GameCard>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 d-flex justify-content-center">
            <GameButton 
                Variant="outline"
                Disabled="@_isCreating"
                OnClick="CreateAnotherRoomAsync">
                <span style="font-size: 1.5rem;">üîÑ</span>
                <span>Crear Nueva Sala</span>
            </GameButton>
        </div>
    }
</div>

@code {
    private GameMode _selectedMode = GameMode.Normal;
    private RoomDto? _room;
    private ElementReference _gameModeSelect;
    private string? _errorMessage;
    private bool _isCreating;
    private bool _isStarting;
    private string? _qrCodeBase64;
    private string? _roomUrl;
    private readonly GameMode[] _availableModes = Enum.GetValues<GameMode>();
    private HubConnection? _hubConnection;

    [Inject]
    private SignalRRoomService RoomService { get; set; } = default!;

    [Inject]
    private QrCodeService QrCodeService { get; set; } = default!;

    [Inject]
    private IConfiguration Configuration { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private string GetModeDescription(GameMode mode) => mode switch
    {
        GameMode.Suave => "Casos suaves, ideal para grupos que se est√°n conociendo",
        GameMode.Normal => "Casos equilibrados para cualquier grupo de amigos",
        GameMode.Spicy => "Casos atrevidos solo para grupos de m√°xima confianza",
        _ => ""
    };

    /// <summary>
    /// Gets the status indicator emoji for a player (RF-013).
    /// </summary>
    private static string GetStatusIndicator(PlayerConnectionStatus status) => status switch
    {
        PlayerConnectionStatus.Conectado => "üü¢",
        PlayerConnectionStatus.Inactivo => "üü°",
        PlayerConnectionStatus.Desconectado => "‚ö´",
        _ => "‚ö™"
    };

    /// <summary>
    /// Gets the status text for a player (RF-013).
    /// </summary>
    private static string GetStatusText(PlayerConnectionStatus status) => status switch
    {
        PlayerConnectionStatus.Conectado => "Conectado",
        PlayerConnectionStatus.Inactivo => "Inactivo",
        PlayerConnectionStatus.Desconectado => "Desconectado",
        _ => ""
    };

    private string GetModeEmoji(GameMode mode) => mode switch
    {
        GameMode.Suave => "üòä",
        GameMode.Normal => "üòé",
        GameMode.Spicy => "üî•",
        _ => "üéÆ"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if there's an existing host session (RF-017)
            await RestoreHostSessionAsync();
            
            try
            {
                await _gameModeSelect.FocusAsync();
            }
            catch (InvalidOperationException)
            {
                // Ignore focus errors if the element is not yet available.
            }
        }
    }

    private string GetModeGradient(GameMode mode) => mode switch
    {
        GameMode.Suave => "linear-gradient(135deg, #06D6A0 0%, #4CC9F0 100%)",
        GameMode.Normal => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)",
        GameMode.Spicy => "linear-gradient(135deg, #F72585 0%, #7209B7 100%)",
        _ => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)"
    };

    private async Task CreateRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        _errorMessage = null;
        _isCreating = true;

        try
        {
            _room = await RoomService.CreateRoomAsync(_selectedMode);
            
            // Generate QR code URL (RF-004)
            var baseUrl = Configuration["BaseUrl"] ?? "https://localhost:7000";
            _roomUrl = RoomService.GenerateRoomUrl(_room.Code, baseUrl);
            _qrCodeBase64 = QrCodeService.GenerateQrCodeBase64(_roomUrl);

            // Save host session (RF-017)
            await SaveHostSessionAsync();

            // Initialize SignalR connection for real-time updates (RF-011)
            await InitializeSignalRConnectionAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task CreateAnotherRoomAsync()
    {
        if (_isCreating)
        {
            return;
        }

        // Dispose of existing SignalR connection
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
            _hubConnection = null;
        }

        _room = null;
        _errorMessage = null;
        _qrCodeBase64 = null;
        _roomUrl = null;

        await CreateRoomAsync();
    }

    private async Task StartGameAsync()
    {
        if (_isStarting || _room is null || !_room.CanStartGame)
        {
            return;
        }

        _isStarting = true;
        _errorMessage = null;

        try
        {
            // TODO: Implement game start logic
            await Task.Delay(1000); // Simulate async operation
            _errorMessage = "Funcionalidad de inicio de partida pendiente de implementaci√≥n.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al iniciar la partida: {ex.Message}";
        }
        finally
        {
            _isStarting = false;
        }
    }

    /// <summary>
    /// Initializes SignalR connection for real-time room updates (RF-011).
    /// The host doesn't need to join as a player but monitors room state.
    /// </summary>
    private async Task InitializeSignalRConnectionAsync()
    {
        if (_room is null)
        {
            return;
        }

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        // Handle room state updates (RF-011)
        _hubConnection.On<RoomDto>("RoomStateUpdated", async (roomDto) =>
        {
            if (roomDto.Code == _room?.Code)
            {
                _room = roomDto;
                await InvokeAsync(StateHasChanged);
            }
        });

        try
        {
            await _hubConnection.StartAsync();
            
            // Join the room group to receive updates
            await _hubConnection.InvokeAsync("JoinRoom", _room.Code, Guid.Empty);
        }
        catch (Exception ex)
        {
            _errorMessage = $"No se pudo conectar al hub: {ex.Message}";
        }
    }

    /// <summary>
    /// Saves the current host session to browser sessionStorage (RF-017).
    /// </summary>
    private async Task SaveHostSessionAsync()
    {
        if (_room is not null)
        {
            try
            {
                var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/sessionStorage.js");
                await module.InvokeVoidAsync("setItem", "host_room_code", _room.Code);
                await module.InvokeVoidAsync("setItem", "host_is_host", "true");
            }
            catch (Exception)
            {
                // Silently fail if sessionStorage is not available
            }
        }
    }

    /// <summary>
    /// Restores the host session from browser sessionStorage (RF-017).
    /// </summary>
    private async Task RestoreHostSessionAsync()
    {
        try
        {
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/sessionStorage.js");
            var roomCode = await module.InvokeAsync<string?>("getItem", "host_room_code");
            var isHost = await module.InvokeAsync<string?>("getItem", "host_is_host");
            
            if (!string.IsNullOrEmpty(roomCode) && isHost == "true" && _room is null)
            {
                // Try to restore the room
                if (GameTribunal.Domain.ValueObjects.RoomCode.TryFrom(roomCode, out var code))
                {
                    var room = await RoomService.GetRoomByCodeAsync(code);
                    if (room is not null)
                    {
                        _room = room;
                        
                        // Generate QR code URL
                        var baseUrl = Configuration["BaseUrl"] ?? "https://localhost:7000";
                        _roomUrl = RoomService.GenerateRoomUrl(_room.Code, baseUrl);
                        _qrCodeBase64 = QrCodeService.GenerateQrCodeBase64(_roomUrl);
                        
                        // Initialize SignalR connection
                        await InitializeSignalRConnectionAsync();
                        
                        // Force UI update
                        await InvokeAsync(StateHasChanged);
                    }
                    else
                    {
                        // Room no longer exists, clear storage
                        await module.InvokeVoidAsync("removeItem", "host_room_code");
                        await module.InvokeVoidAsync("removeItem", "host_is_host");
                    }
                }
            }
        }
        catch (Exception)
        {
            // Silently fail if sessionStorage is not available or room restoration fails
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
