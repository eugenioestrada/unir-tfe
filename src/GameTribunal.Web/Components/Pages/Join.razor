@page "/join/{roomCode}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

<PageTitle>Unirse - Pandorium</PageTitle>

<div class="game-container game-animate-fadeIn">
    <!-- Mobile-optimized header -->
    <div class="text-center mb-4">
        <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--color-light); text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            ‚öñÔ∏è Pandorium
        </h1>
    </div>

    @if (_room is null && !_isLoading)
    {
        <!-- Room Not Found -->
        <GameCard>
            <Body>
                <GameStack Direction="vertical" Gap="3">
                    <GameAlert Variant="danger" Icon="‚ùå">
                        <Title>Sala no encontrada</Title>
                        <Message>
                            El c√≥digo "<strong>@RoomCode</strong>" no existe o ya no est√° disponible.
                        </Message>
                    </GameAlert>
                    
                    <div class="text-center">
                        <a href="/" class="game-btn game-btn-primary game-btn-lg">
                            <span style="font-size: 1.5rem;">üè†</span>
                            <span>Volver al Inicio</span>
                        </a>
                    </div>
                </GameStack>
            </Body>
        </GameCard>
    }
    else if (_isLoading)
    {
        <!-- Loading State -->
        <GameCard>
            <Body>
                <GameLoadingSpinner Size="lg" Text="Verificando sala..." Centered="true" />
            </Body>
        </GameCard>
    }
    else if (_hasJoined)
    {
        <!-- Successfully Joined -->
        <GameCard class="game-animate-fadeIn">
            <Body>
                <GameStack Direction="vertical" Gap="3">
                    <GameAlert Variant="success" Icon="üéâ">
                        <Title>¬°Bienvenido/a!</Title>
                        <Message>
                            Te has unido como <strong>@_playerAlias</strong>
                        </Message>
                    </GameAlert>

                    <div class="d-flex align-items-center justify-content-between">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0;">
                            üë• Sala: @_room!.Code
                        </h3>
                        @if (_hubConnection?.State == HubConnectionState.Connected)
                        {
                            <GameBadge Variant="success">‚óè En vivo</GameBadge>
                        }
                        else if (_isReconnecting)
                        {
                            <GameBadge Variant="warning">‚óè Reconectando...</GameBadge>
                        }
                    </div>

                    <div>
                        <span style="background: @GetModeGradient(_room.Mode); display: inline-flex; align-items: center; padding: var(--space-xs) var(--space-lg); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); border-radius: var(--radius-full); white-space: nowrap; color: var(--color-light);">
                            @GetModeEmoji(_room.Mode) Modo @_room.Mode
                        </span>
                        <GameBadge Variant="primary" Size="lg" class="ms-2">
                            @_room.Players.Count / @Room.MaxPlayers jugadores
                        </GameBadge>
                    </div>

                    @if (!_room.CanStartGame)
                    {
                        <GameAlert Variant="info" Icon="‚è≥">
                            <Title>Esperando m√°s jugadores</Title>
                            <Message>
                                Se necesitan al menos @Room.MinPlayers jugadores 
                                (@_room.Players.Count/@Room.MinPlayers)
                            </Message>
                        </GameAlert>
                    }
                    else
                    {
                        <GameAlert Variant="success">
                            <Title>¬°Listos para empezar!</Title>
                            <Message>El host puede iniciar la partida</Message>
                        </GameAlert>
                    }
                </GameStack>
            </Body>
        </GameCard>

        <!-- Players List -->
        <GameCard class="mt-3 game-animate-slideIn">
            <Header>
                <h3 class="game-card-title" style="font-size: 1.25rem;">
                    Jugadores Conectados (@_room!.Players.Count)
                </h3>
            </Header>
            <Body>
                <ul class="game-player-list">
                    @{
                        var playerIndex = 0;
                    }
                    @foreach (var player in _room.Players)
                    {
                        playerIndex++;
                        <li class="game-player-item @(player.Alias == _playerAlias ? "is-current-player" : "")">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 1.5rem;">
                                    @(player.Alias == _playerAlias ? "üë§" : "üë•")
                                </span>
                                <span class="game-player-name">@player.Alias</span>
                            </div>
                            @if (player.Alias == _playerAlias)
                            {
                                <GameBadge Variant="primary">T√∫</GameBadge>
                            }
                            else
                            {
                                <GameBadge Variant="secondary">
                                    #@playerIndex
                                </GameBadge>
                            }
                        </li>
                    }
                </ul>
            </Body>
        </GameCard>
    }
    else
    {
        <!-- Join Form -->
        <GameCard class="game-animate-fadeIn">
            <Header>
                <h2 class="game-card-title">
                    üéÆ Unirse a la Sala
                </h2>
            </Header>
            <Body>
                <GameStack Direction="vertical" Gap="3">
                    <div class="text-center">
                        <div class="game-room-code" style="font-size: 3rem;">
                            @RoomCode
                        </div>
                        <div class="mt-2">
                            <span style="background: @GetModeGradient(_room!.Mode); display: inline-flex; align-items: center; padding: var(--space-xs) var(--space-lg); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); border-radius: var(--radius-full); white-space: nowrap; color: var(--color-light);">
                                @GetModeEmoji(_room.Mode) Modo @_room.Mode
                            </span>
                        </div>
                        <p class="text-muted mt-2" style="font-size: 0.875rem;">
                            @GetModeDescription(_room.Mode)
                        </p>
                    </div>

                    @if (_errorMessage is not null)
                    {
                        <GameAlert Variant="danger">
                            <Title>Error</Title>
                            <Message>@_errorMessage</Message>
                        </GameAlert>
                    }

                    <div class="game-form-group">
                        <label class="game-label" for="alias">
                            <span style="font-size: 1.25rem;">üë§</span> Tu Alias
                        </label>
                        <input 
                            type="text" 
                            class="game-input" 
                            id="alias" 
                            @bind="_alias"
                            @bind:event="oninput"
                            placeholder="Escribe tu nombre..."
                            maxlength="20"
                            disabled="@_isJoining"
                            style="font-size: 1.25rem; padding: 1rem 1.25rem;" />
                        <small class="text-muted mt-1" style="display: block; font-size: 0.875rem;">
                            2-20 caracteres. Debe ser √∫nico en la sala.
                        </small>
                    </div>

                    <GameButton 
                        Variant="primary" 
                        Size="lg" 
                        FullWidth="true"
                        IsLoading="@_isJoining"
                        Disabled="@string.IsNullOrWhiteSpace(_alias)"
                        OnClick="JoinRoomAsync">
                        <span style="font-size: 1.5rem;">üöÄ</span>
                        <span>Unirse a la Sala</span>
                    </GameButton>
                </GameStack>
            </Body>
        </GameCard>

        <!-- Info Card -->
        <GameCard class="mt-3">
            <Body>
                <GameStack Direction="vertical" Gap="2" AlignItems="center">
                    <div style="font-size: 2.5rem;">üì±</div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin: 0;">Mant√©n tu m√≥vil cerca</h4>
                    <p class="text-muted text-center" style="font-size: 0.875rem; margin: 0;">
                        Usar√°s tu dispositivo para votar y participar durante la partida
                    </p>
                </GameStack>
            </Body>
        </GameCard>
    }
</div>

@code {
    [Parameter]
    public string RoomCode { get; set; } = default!;

    [Inject]
    private SignalRRoomService RoomService { get; set; } = default!;

    [Inject]
    private IRoomRepository RoomRepository { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private RoomDto? _room;
    private string _alias = string.Empty;
    private string? _errorMessage;
    private bool _isLoading = true;
    private bool _isJoining;
    private bool _hasJoined;
    private string? _playerAlias;
    private Guid? _playerId;
    private HubConnection? _hubConnection;
    private bool _isReconnecting;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomAsync();
        
        // Initialize SignalR connection (RF-011, RF-012)
        await InitializeSignalRConnectionAsync();
    }

    private string GetModeDescription(GameMode mode) => mode switch
    {
        GameMode.Suave => "Casos suaves para conocerse mejor",
        GameMode.Normal => "Casos equilibrados y divertidos",
        GameMode.Spicy => "Casos atrevidos para grupos de confianza",
        _ => ""
    };

    private string GetModeEmoji(GameMode mode) => mode switch
    {
        GameMode.Suave => "üòä",
        GameMode.Normal => "üòé",
        GameMode.Spicy => "üî•",
        _ => "üéÆ"
    };

    private string GetModeGradient(GameMode mode) => mode switch
    {
        GameMode.Suave => "linear-gradient(135deg, #06D6A0 0%, #4CC9F0 100%)",
        GameMode.Normal => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)",
        GameMode.Spicy => "linear-gradient(135deg, #F72585 0%, #7209B7 100%)",
        _ => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)"
    };

    private async Task LoadRoomAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (GameTribunal.Domain.ValueObjects.RoomCode.TryFrom(RoomCode, out var code))
            {
                var room = await RoomRepository.GetByCodeAsync(code);
                if (room is not null)
                {
                    _room = new RoomDto(
                        room.Code.Value,
                        room.Mode,
                        room.Players.Select(p => new PlayerDto(p.Id, p.Alias)).ToList(),
                        room.CanStartGame()
                    );
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar la sala: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task JoinRoomAsync()
    {
        if (_isJoining || string.IsNullOrWhiteSpace(_alias))
        {
            return;
        }

        _errorMessage = null;
        _isJoining = true;

        try
        {
            _room = await RoomService.JoinRoomAsync(RoomCode, _alias.Trim());
            _hasJoined = true;
            _playerAlias = _alias.Trim();
            
            // Find the player ID
            var player = _room.Players.FirstOrDefault(p => p.Alias == _playerAlias);
            if (player != null)
            {
                _playerId = player.Id;
                
                // Store player ID in browser storage for reconnection (RF-012)
                await StorePlayerIdAsync();
                
                // Join SignalR room group (RF-011)
                if (_hubConnection?.State == HubConnectionState.Connected)
                {
                    await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId);
                }
            }
        }
        catch (InvalidOperationException ex)
        {
            if (ex.Message.Contains("already exists"))
            {
                _errorMessage = $"El alias '{_alias.Trim()}' ya est√° en uso. Por favor, elige otro.";
            }
            else if (ex.Message.Contains("maximum capacity"))
            {
                _errorMessage = "La sala est√° llena. No se pueden agregar m√°s jugadores.";
            }
            else
            {
                _errorMessage = ex.Message;
            }
        }
        catch (ArgumentException ex)
        {
            _errorMessage = $"Alias inv√°lido: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al unirse a la sala: {ex.Message}";
        }
        finally
        {
            _isJoining = false;
        }
    }

    /// <summary>
    /// Initializes SignalR connection for real-time updates (RF-011, RF-012).
    /// </summary>
    private async Task InitializeSignalRConnectionAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect() // RF-012: Automatic reconnection
            .Build();

        // Handle room state updates (RF-011)
        _hubConnection.On<RoomDto>("RoomStateUpdated", async (roomDto) =>
        {
            _room = roomDto;
            await InvokeAsync(StateHasChanged);
        });

        // Handle reconnecting state (RF-012)
        _hubConnection.Reconnecting += error =>
        {
            _isReconnecting = true;
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        // Handle reconnected state (RF-012)
        _hubConnection.Reconnected += async connectionId =>
        {
            _isReconnecting = false;
            
            // Re-join the room after reconnection
            if (_hasJoined && _playerId.HasValue)
            {
                await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId.Value);
            }
            
            await InvokeAsync(StateHasChanged);
        };

        // Handle disconnection (RF-012)
        _hubConnection.Closed += async error =>
        {
            _isReconnecting = false;
            await InvokeAsync(StateHasChanged);
        };

        try
        {
            await _hubConnection.StartAsync();
            
            // Check for existing session (RF-012: reconnection support)
            await CheckExistingSessionAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"No se pudo conectar al servidor: {ex.Message}";
        }
    }

    /// <summary>
    /// Checks if player has an existing session and can reconnect (RF-012).
    /// </summary>
    private async Task CheckExistingSessionAsync()
    {
        // Try to retrieve stored player ID
        var storedPlayerId = await GetStoredPlayerIdAsync();
        if (storedPlayerId.HasValue && _hubConnection?.State == HubConnectionState.Connected)
        {
            var existingRoomCode = await _hubConnection.InvokeAsync<string?>("CheckPlayerSession", storedPlayerId.Value);
            if (existingRoomCode == RoomCode)
            {
                // Player has an existing session in this room, attempt to restore
                _playerId = storedPlayerId.Value;
                await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId.Value);
                
                // Reload room state
                await LoadRoomAsync();
                
                // Set player info if they're still in the room
                var player = _room?.Players.FirstOrDefault(p => p.Id == _playerId.Value);
                if (player != null)
                {
                    _hasJoined = true;
                    _playerAlias = player.Alias;
                }
            }
        }
    }

    /// <summary>
    /// Stores player ID in browser session storage for reconnection.
    /// </summary>
    private Task StorePlayerIdAsync()
    {
        // In a real implementation, use JSInterop to store in sessionStorage
        // For now, we rely on in-memory state
        return Task.CompletedTask;
    }

    /// <summary>
    /// Retrieves stored player ID from browser session storage.
    /// </summary>
    private Task<Guid?> GetStoredPlayerIdAsync()
    {
        // In a real implementation, use JSInterop to retrieve from sessionStorage
        // For now, return null
        return Task.FromResult<Guid?>(null);
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
