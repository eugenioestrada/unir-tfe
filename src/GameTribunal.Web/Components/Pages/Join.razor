@page "/join/{roomCode}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

<PageTitle>Unirse - Tribunal Social</PageTitle>

<div class="game-container game-animate-fadeIn">
    <!-- Mobile-optimized header -->
    <div class="text-center mb-4">
        <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--color-light); text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            ‚öñÔ∏è TRIBUNAL SOCIAL
        </h1>
    </div>

    @if (_room is null && !_isLoading)
    {
        <!-- Room Not Found -->
        <div class="game-card">
            <div class="game-alert game-alert-danger">
                <span style="font-size: 2rem;">‚ùå</span>
                <div>
                    <strong>Sala no encontrada</strong>
                    <p class="mb-0">
                        El c√≥digo "<strong>@RoomCode</strong>" no existe o ya no est√° disponible.
                    </p>
                </div>
            </div>
            <div class="mt-3 text-center">
                <a href="/" class="game-btn game-btn-primary game-btn-lg">
                    <span style="font-size: 1.5rem;">üè†</span>
                    <span>Volver al Inicio</span>
                </a>
            </div>
        </div>
    }
    else if (_isLoading)
    {
        <!-- Loading State -->
        <div class="game-card">
            <div class="game-loading-container">
                <div class="game-spinner game-spinner-lg"></div>
                <p class="game-loading-text">Verificando sala...</p>
            </div>
        </div>
    }
    else if (_hasJoined)
    {
        <!-- Successfully Joined -->
        <div class="game-card game-animate-fadeIn">
            <div class="game-alert game-alert-success">
                <span style="font-size: 2rem;">üéâ</span>
                <div>
                    <strong>¬°Bienvenido/a!</strong>
                    <p class="mb-0">
                        Te has unido como <strong>@_playerAlias</strong>
                    </p>
                </div>
            </div>

            <div class="mt-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0;">
                        üë• Sala: @_room!.Code
                    </h3>
                    @if (_hubConnection?.State == HubConnectionState.Connected)
                    {
                        <span class="game-badge game-badge-success">‚óè En vivo</span>
                    }
                    else if (_isReconnecting)
                    {
                        <span class="game-badge game-badge-warning">‚óè Reconectando...</span>
                    }
                </div>

                <div class="mb-3">
                    <span class="game-badge game-badge-lg" 
                          style="background: @GetModeGradient(_room.Mode)">
                        @GetModeEmoji(_room.Mode) Modo @_room.Mode
                    </span>
                    <span class="game-badge game-badge-lg game-badge-primary ms-2">
                        @_room.Players.Count / @Room.MaxPlayers jugadores
                    </span>
                </div>

                @if (!_room.CanStartGame)
                {
                    <div class="game-alert game-alert-info">
                        <span style="font-size: 1.5rem;">‚è≥</span>
                        <div>
                            <strong>Esperando m√°s jugadores</strong>
                            <p class="mb-0">
                                Se necesitan al menos @Room.MinPlayers jugadores 
                                (@_room.Players.Count/@Room.MinPlayers)
                            </p>
                        </div>
                    </div>
                }
                else
                {
                    <div class="game-alert game-alert-success">
                        <span style="font-size: 1.5rem;">‚úÖ</span>
                        <div>
                            <strong>¬°Listos para empezar!</strong>
                            <p class="mb-0">El host puede iniciar la partida</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Players List -->
        <div class="game-card mt-3 game-animate-slideIn">
            <div class="game-card-header">
                <h3 class="game-card-title" style="font-size: 1.25rem;">
                    Jugadores Conectados (@_room!.Players.Count)
                </h3>
            </div>
            <div class="game-card-body">
                <ul class="game-player-list">
                    @{
                        var playerIndex = 0;
                    }
                    @foreach (var player in _room.Players)
                    {
                        playerIndex++;
                        <li class="game-player-item">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 1.5rem;">
                                    @(player.Alias == _playerAlias ? "üë§" : "üë•")
                                </span>
                                <span class="game-player-name">@player.Alias</span>
                            </div>
                            @if (player.Alias == _playerAlias)
                            {
                                <span class="game-badge game-badge-primary">T√∫</span>
                            }
                            else
                            {
                                <span class="game-badge game-badge-secondary">
                                    #@playerIndex
                                </span>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
    else
    {
        <!-- Join Form -->
        <div class="game-card game-animate-fadeIn">
            <div class="game-card-header">
                <h2 class="game-card-title">
                    üéÆ Unirse a la Sala
                </h2>
            </div>
            <div class="game-card-body">
                <div class="mb-4 text-center">
                    <div class="game-room-code" style="font-size: 3rem;">
                        @RoomCode
                    </div>
                    <div class="mt-2">
                        <span class="game-badge game-badge-lg" 
                              style="background: @GetModeGradient(_room!.Mode)">
                            @GetModeEmoji(_room.Mode) Modo @_room.Mode
                        </span>
                    </div>
                    <p class="text-muted mt-2" style="font-size: 0.875rem;">
                        @GetModeDescription(_room.Mode)
                    </p>
                </div>

                @if (_errorMessage is not null)
                {
                    <div class="game-alert game-alert-danger">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Error</strong>
                            <p class="mb-0">@_errorMessage</p>
                        </div>
                    </div>
                }

                <div class="game-form-group">
                    <label class="game-label" for="alias">
                        <span style="font-size: 1.25rem;">üë§</span> Tu Alias
                    </label>
                    <input 
                        type="text" 
                        class="game-input" 
                        id="alias" 
                        @bind="_alias"
                        @bind:event="oninput"
                        placeholder="Escribe tu nombre..."
                        maxlength="20"
                        disabled="@_isJoining"
                        style="font-size: 1.25rem; padding: 1rem 1.25rem;" />
                    <small class="text-muted mt-1" style="display: block; font-size: 0.875rem;">
                        2-20 caracteres. Debe ser √∫nico en la sala.
                    </small>
                </div>

                <button 
                    class="game-btn game-btn-primary game-btn-lg game-btn-block" 
                    @onclick="JoinRoomAsync" 
                    disabled="@(_isJoining || string.IsNullOrWhiteSpace(_alias))">
                    @if (_isJoining)
                    {
                        <span class="game-spinner"></span>
                        <span>Uni√©ndose...</span>
                    }
                    else
                    {
                        <span style="font-size: 1.5rem;">üöÄ</span>
                        <span>Unirse a la Sala</span>
                    }
                </button>
            </div>
        </div>

        <!-- Info Card -->
        <div class="game-card mt-3">
            <div style="text-align: center;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì±</div>
                <h4 style="font-size: 1.125rem; font-weight: 600;">Mant√©n tu m√≥vil cerca</h4>
                <p class="text-muted" style="font-size: 0.875rem; margin: 0;">
                    Usar√°s tu dispositivo para votar y participar durante la partida
                </p>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string RoomCode { get; set; } = default!;

    [Inject]
    private SignalRRoomService RoomService { get; set; } = default!;

    [Inject]
    private IRoomRepository RoomRepository { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private RoomDto? _room;
    private string _alias = string.Empty;
    private string? _errorMessage;
    private bool _isLoading = true;
    private bool _isJoining;
    private bool _hasJoined;
    private string? _playerAlias;
    private Guid? _playerId;
    private HubConnection? _hubConnection;
    private bool _isReconnecting;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomAsync();
        
        // Initialize SignalR connection (RF-011, RF-012)
        await InitializeSignalRConnectionAsync();
    }

    private string GetModeDescription(GameMode mode) => mode switch
    {
        GameMode.Suave => "Casos suaves para conocerse mejor",
        GameMode.Normal => "Casos equilibrados y divertidos",
        GameMode.Spicy => "Casos atrevidos para grupos de confianza",
        _ => ""
    };

    private string GetModeEmoji(GameMode mode) => mode switch
    {
        GameMode.Suave => "üòä",
        GameMode.Normal => "üòé",
        GameMode.Spicy => "üî•",
        _ => "üéÆ"
    };

    private string GetModeGradient(GameMode mode) => mode switch
    {
        GameMode.Suave => "linear-gradient(135deg, #06D6A0 0%, #4CC9F0 100%)",
        GameMode.Normal => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)",
        GameMode.Spicy => "linear-gradient(135deg, #F72585 0%, #7209B7 100%)",
        _ => "linear-gradient(135deg, #FF6B35 0%, #F72585 100%)"
    };

    private async Task LoadRoomAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (GameTribunal.Domain.ValueObjects.RoomCode.TryFrom(RoomCode, out var code))
            {
                var room = await RoomRepository.GetByCodeAsync(code);
                if (room is not null)
                {
                    _room = new RoomDto(
                        room.Code.Value,
                        room.Mode,
                        room.Players.Select(p => new PlayerDto(p.Id, p.Alias)).ToList(),
                        room.CanStartGame()
                    );
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar la sala: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task JoinRoomAsync()
    {
        if (_isJoining || string.IsNullOrWhiteSpace(_alias))
        {
            return;
        }

        _errorMessage = null;
        _isJoining = true;

        try
        {
            _room = await RoomService.JoinRoomAsync(RoomCode, _alias.Trim());
            _hasJoined = true;
            _playerAlias = _alias.Trim();
            
            // Find the player ID
            var player = _room.Players.FirstOrDefault(p => p.Alias == _playerAlias);
            if (player != null)
            {
                _playerId = player.Id;
                
                // Store player ID in browser storage for reconnection (RF-012)
                await StorePlayerIdAsync();
                
                // Join SignalR room group (RF-011)
                if (_hubConnection?.State == HubConnectionState.Connected)
                {
                    await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId);
                }
            }
        }
        catch (InvalidOperationException ex)
        {
            if (ex.Message.Contains("already exists"))
            {
                _errorMessage = $"El alias '{_alias.Trim()}' ya est√° en uso. Por favor, elige otro.";
            }
            else if (ex.Message.Contains("maximum capacity"))
            {
                _errorMessage = "La sala est√° llena. No se pueden agregar m√°s jugadores.";
            }
            else
            {
                _errorMessage = ex.Message;
            }
        }
        catch (ArgumentException ex)
        {
            _errorMessage = $"Alias inv√°lido: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al unirse a la sala: {ex.Message}";
        }
        finally
        {
            _isJoining = false;
        }
    }

    /// <summary>
    /// Initializes SignalR connection for real-time updates (RF-011, RF-012).
    /// </summary>
    private async Task InitializeSignalRConnectionAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect() // RF-012: Automatic reconnection
            .Build();

        // Handle room state updates (RF-011)
        _hubConnection.On<RoomDto>("RoomStateUpdated", async (roomDto) =>
        {
            _room = roomDto;
            await InvokeAsync(StateHasChanged);
        });

        // Handle reconnecting state (RF-012)
        _hubConnection.Reconnecting += error =>
        {
            _isReconnecting = true;
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        // Handle reconnected state (RF-012)
        _hubConnection.Reconnected += async connectionId =>
        {
            _isReconnecting = false;
            
            // Re-join the room after reconnection
            if (_hasJoined && _playerId.HasValue)
            {
                await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId.Value);
            }
            
            await InvokeAsync(StateHasChanged);
        };

        // Handle disconnection (RF-012)
        _hubConnection.Closed += async error =>
        {
            _isReconnecting = false;
            await InvokeAsync(StateHasChanged);
        };

        try
        {
            await _hubConnection.StartAsync();
            
            // Check for existing session (RF-012: reconnection support)
            await CheckExistingSessionAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"No se pudo conectar al servidor: {ex.Message}";
        }
    }

    /// <summary>
    /// Checks if player has an existing session and can reconnect (RF-012).
    /// </summary>
    private async Task CheckExistingSessionAsync()
    {
        // Try to retrieve stored player ID
        var storedPlayerId = await GetStoredPlayerIdAsync();
        if (storedPlayerId.HasValue && _hubConnection?.State == HubConnectionState.Connected)
        {
            var existingRoomCode = await _hubConnection.InvokeAsync<string?>("CheckPlayerSession", storedPlayerId.Value);
            if (existingRoomCode == RoomCode)
            {
                // Player has an existing session in this room, attempt to restore
                _playerId = storedPlayerId.Value;
                await _hubConnection.InvokeAsync("JoinRoom", RoomCode, _playerId.Value);
                
                // Reload room state
                await LoadRoomAsync();
                
                // Set player info if they're still in the room
                var player = _room?.Players.FirstOrDefault(p => p.Id == _playerId.Value);
                if (player != null)
                {
                    _hasJoined = true;
                    _playerAlias = player.Alias;
                }
            }
        }
    }

    /// <summary>
    /// Stores player ID in browser session storage for reconnection.
    /// </summary>
    private Task StorePlayerIdAsync()
    {
        // In a real implementation, use JSInterop to store in sessionStorage
        // For now, we rely on in-memory state
        return Task.CompletedTask;
    }

    /// <summary>
    /// Retrieves stored player ID from browser session storage.
    /// </summary>
    private Task<Guid?> GetStoredPlayerIdAsync()
    {
        // In a real implementation, use JSInterop to retrieve from sessionStorage
        // For now, return null
        return Task.FromResult<Guid?>(null);
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
